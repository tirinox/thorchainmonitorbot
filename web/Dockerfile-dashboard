FROM python:3.11-slim as production

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

# Copy only requirements first for better layer caching
# (Adjust path to where your file actually is)
COPY app/requirements.txt /app/requirements.txt

# System deps that commonly help build native wheels; prune if unneeded
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
        build-essential git cmake pkg-config && \
    rm -rf /var/lib/apt/lists/*

# Newer pip/setuptools/wheel avoid many build issues on 3.11
RUN python -m pip install --upgrade pip setuptools wheel packaging

# Optional: strip any accidental "distutils" line from requirements
# (safe no-op if not present)
RUN awk 'tolower($0)!="distutils"' requirements.txt > /tmp/reqs.txt

# Install your deps
RUN pip install -r /tmp/reqs.txt

# If you want Streamlit regardless of requirements.txt, keep this;
# otherwise add it to requirements.txt and remove this line.
RUN pip install streamlit streamlit_autorefresh

# Copy the rest of the app
COPY app/ /app/

EXPOSE 8501

# If dashboard.py expects its own argv, pass them after "--"
# Example: streamlit run script.py -- --config /config/config.yaml
CMD ["streamlit", "run", "dashboard.py", \
     "--server.port=8501", "--server.enableCORS=false", "--server.address=127.0.0.1", \
     "--", "/config/config.yaml"]